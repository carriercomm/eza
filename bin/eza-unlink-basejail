#!/bin/sh

if [ "x" == "x${SQUID}" ]; then
    SQUID="10.7.7.1:3128"
fi
JAILNAME=$1

if [ "x" != "x${JAILNAME}" ]; then
    for i in bin boot lib libexec rescue sbin \
        usr/bin usr/include usr/lib usr/lib32 usr/libdata usr/libexec usr/ports \
        usr/sbin usr/share usr/src ; do
        if [ -h /usr/jails/${JAILNAME}/${i} ]; then
                                                rm  /usr/jails/${JAILNAME}/${i}
            rsync -vialP /usr/jails/basejail/${i}/  /usr/jails/${JAILNAME}/${i}/
        fi
    done
    cat /usr/local/etc/fstab.${JAILNAME} \
        | awk '{print "# "$0}' \
        >/tmp/fstab.${JAILNAME}
    cat  /tmp/fstab.${JAILNAME} >/usr/local/etc/fstab.${JAILNAME}
    rm   /tmp/fstab.${JAILNAME}
    [ -e /etc/resolv.conf ] \
        && cp /etc/resolv.conf /usr/jails/${JAILNAME}/etc/
    [ -e /etc/hosts ] \
        && cp /etc/hosts /usr/jails/${JAILNAME}/etc/
    [ -e ~/bin/fres ] \
        && cp ~/bin/fres /usr/jails/${JAILNAME}/root/
    [ -e /usr/local/sbin/pkg-static ] \
        && [ ! -e /usr/jails/${JAILNAME}/sbin/pkg-static ] \
        && cp -a /usr/local/sbin/pkg-static /usr/jails/${JAILNAME}/sbin/
    # Not squid jail otherwise recursive dependency
    if [ "xsquid" != "x${JAILNAME}" ]; then
        # Thanks to @tomster via https://github.com/freebsd/pkg/issues/1181
        install -d -m 755 /usr/jails/${JAILNAME}/usr/local/etc
        cat >/usr/jails/${JAILNAME}/usr/local/etc/pkg.conf <<EOF
# Sample alias settings
ALIAS              : {
  all-depends: query %dn-%dv,
  annotations: info -A,
  build-depends: info -qd,
  cinfo: info -Cx,
  comment: query -i "%c",
  csearch: search -Cx,
  desc: query -i "%e",
  download: fetch,
  iinfo: info -ix,
  isearch: search -ix,
  prime-list: "query -e '%a = 0' '%n'",
  leaf: "query -e '%#r == 0' '%n-%v'",
  list: info -ql,
  noauto = "query -e '%a == 0' '%n-%v'",
  options: query -i "%n - %Ok: %Ov",
  origin: info -qo,
  provided-depends: info -qb,
  raw: info -R,
  required-depends: info -qr,
  roptions: rquery -i "%n - %Ok: %Ov",
  shared-depends: info -qB,
  show: info -f -k,
  size: info -sq,
}
PKG_ENV : {
  HTTP_PROXY: "http://${SQUID}",
  HTTPS_PROXY: "http://${SQUID}"
}
EOF
        chmod 644 /usr/jails/${JAILNAME}/usr/local/etc/pkg.conf
        install -d -m 700 /usr/jails/${JAILNAME}/root/local
        echo "setenv HTTP_PROXY \"http://${SQUID}\"" >>/usr/jails/${JAILNAME}/root/local/cshproxy
        MYENV="env PAGER=cat HTTP_PROXY=http://${SQUID}"
    else
        [ -d /boot/packages ] \
            && rsync -vialP /boot/packages/  /usr/jails/${JAILNAME}/boot/packages/ \
            && eza console -f -e "pkg-static add $( ls /boot/packages/*.t?z )" ${JAILNAME}
        MYENV="env PAGER=cat"
    fi
    eza console -f -e "${MYENV} freebsd-update -F fetch install" ${JAILNAME}
    eza console -f -e "pkg-static install -y pkg git" ${JAILNAME}
    eza console -f -e "sh /root/fres" ${JAILNAME}
    eza console -f -e "rm /root/fres" ${JAILNAME}
else
    echo "ERROR: missing jail name" >&2
    exit 1
fi
